@page "/"
@inject UserService UserService
@inject NavigationManager NavigationManager
@inject Blazored.LocalStorage.ILocalStorageService localStorage

<div id="login-page">
    <div class="design-corner top-right-light"></div>
    <div class="design-corner top-right-dark"></div>

    <div class="design-corner bottom-left-light"></div> 
    <div class="design-corner bottom-left-dark"></div>

    <img src="resources/images/logo2.svg" alt="ShareCare Logo" class="logo" />

    <div class="text-container">
        <h1 class="login-title">Login</h1>
        <p class="login-subtitle">Please sign in to continue</p>
    </div>

    <div class="input-container"> 
        <input @bind="Username" placeholder="Username" type="text" class="input-field" autofocus />
        <input @bind="Password" placeholder="Password" type="password" class="input-field" />
    </div>

    <div class="remember-forgot-container">
        <label class="remember-me">
            <input @bind="RememberMe" type="checkbox" /> Remember me
        </label>
        <label class="forgot-password"> <a href="">Forgot password?</a> </label>
    </div>

    <button @onclick="LoginUser" class="login-btn" disabled="@IsLoading">
        <span>Login</span>
    </button>

    <div class="register">
        <p>New user? <a href="/register">Sign up</a></p>
    </div>

    @if (Message != null)
    {
        <p class="message">@Message</p>
    }
</div>

@code {
    private string Username;
    private string Password;
    private string Message;
    private bool RememberMe;
    private bool IsLoading = false;

    protected override async Task OnInitializedAsync()
    {
        var rememberedUsername = await localStorage.GetItemAsync<string>("username");
        var rememberedPassword = await localStorage.GetItemAsync<string>("password");
        if (!string.IsNullOrEmpty(rememberedUsername) && !string.IsNullOrEmpty(rememberedPassword))
        {
            Username = rememberedUsername;
            Password = rememberedPassword;
            RememberMe = true;
        }
    }

    private async Task LoginUser()
    {
        if (string.IsNullOrEmpty(Username) || string.IsNullOrEmpty(Password))
        {
            Message = "Please enter both username and password.";
            return;
        }

        IsLoading = true;

        var success = await UserService.LoginUser(Username, Password);
        if (success)
        {
            if (RememberMe)
            {
                await localStorage.SetItemAsync("username", Username);
                await localStorage.SetItemAsync("password", Password);
            }
            else
            {
                await localStorage.RemoveItemAsync("username");
                await localStorage.RemoveItemAsync("password");
            }

            Message = "Login successful!";
            NavigationManager.NavigateTo("/home");
        }
        else
        {
            Message = "Invalid username or password.";
        }

        IsLoading = false;
    }
}